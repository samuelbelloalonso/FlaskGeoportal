{% extends "/base/base.html" %}

{% block script %}

<!-- javascript parte del mapa -->
<script>

    var overlayMaps = {
        'ALL': L.tileLayer.wms('http://localhost:8080/geoserver/TFG_Geoportal/wms?', {
            layerName: 'all',
            layers: 'estrada_l_25',
            format: 'image/png',
            transparent: true,
        }),      

        {% for tipoEstrada in tiposEstrada %}
    '{{tipoEstrada}}': L.tileLayer.wms('http://localhost:8080/geoserver/TFG_Geoportal/wms?', {
        layerName: 'tipoestrada',
        layers: 'estrada_l_25',
        format: 'image/png',
        CQL_FILTER: 'categoria=\'{{tipoEstrada}}\'',
        transparent: true,
    }),
        {% endfor %}
        }

    L.control.layers(mapaBaseOSM, overlayMaps).addTo(map);

    function aConsultasComponentes(id) {
        $.get(`/consultasComponentes?activo=${id}`, function (response) {
            $('#injectTarget').html(response)
        });
    }

</script>

<script>
    //Función para renderizar el resultado de la peticion ajax
    //devuelve la consulta
    //borra la tabla y la reescribe
    function renderFormResults(response) {
        var len = Object.keys(response.json_list).length;
        $("#tablaResultados > tbody").empty()
        for (i = 0; i < len; i++) {
            var aux = response.json_list[i];
            //tr inicia una fila nueva
            html = `<tr class="idEstrada">` +
                `<td>${i + 1}</td>` +
                `<td>${aux.id}</td>` +
                `<td>${aux.categoria}</td>` +
                `<td>${aux.matricula}</td>` +
                `<td><button onclick="escondeTablaMuestraDetalles(${aux.id})" class="btn btn-primary btn-sm">edit</button></td>` +
                '</tr>';
            $("#tablaResultados > tbody").append(html);
        }
        $("#divAcciones").hide();
        $("#divResultados").scrollTop(0).show();
    }

    function escondeTablaMuestraDetalles(id) {
        $("button").prop("disabled", true)
        $.get(`/consultasActivos?tramo=${id}`, function (response) {
            $("#injectTarget").html(response);
            $("#divResultados").hide();
            $("#divAcciones").scrollTop(0).show();
            $("button").prop("disabled", false)
        });
    }
    function escondeDetallesMuestraTabla() {
        $("#divResultados").show();
        $("#divAcciones").hide();
    }

    //peticion ajax mandandole la categoria
    $(function () {
        //click en enviar
        $("#ajaxTrigger_form").click(function () {
            $.ajax({
                url: "/consultasTramos",
                data: $("form").serialize(),
                type: "POST",
                dataType: "json",
                success: renderFormResults
            });
        });
    });


    function ajaxRenderizado() {
        $.ajax({
            url: "/consultasTramos",
            data: $("form").serialize(),
            type: "POST",
            dataType: "json",
            success: renderFormResults
        })
    }




</script>

{% endblock %}


{% block asideForm %}

<!--SELECCIONAR CATEGORIA-->
<!-- Formulario -->
<form action="{{ url_for(request.endpoint) }}" method="POST">
    <div class="mb-3">
        <label for="categoria" class="form-label">Selecciona una categoría:</label>
        <select name="categoria" class="form-select">
            {% for tipoEstrada in tiposEstrada %}
            <option value="{{tipoEstrada}}">{{tipoEstrada}}</option>
            {% endfor %}
        </select>
    </div>
    <div>
        <button id="ajaxTrigger_form" type="button" class="btn btn-primary">Enviar</button>
    </div>
</form>
<br></br>

<style>
    #tablaResultados {
        width: 100%;
    }
</style>

<!-- CARA A -->
<div id="divResultados" style="display:none;height:330px" class="scroll border rounded overflow-auto">
    <table id="tablaResultados" class="table table-striped table-hover">
        <thead>
            <tr>
                <th scope="col">#</th>
                <th scope="col">ID</th>
                <th scope="col">Categoria</th>
                <th scope="col">Matricula</th>
                <th scope="col">Acciones</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<!-- CARA B -->
<!-- <div id="divAcciones" style="display:none">
    <div style="height:300px" class="scroll border rounded overflow-auto">
        <iframe id="iframeAcciones" width="100%" height="100%" style="overflow: hidden" scrolling="no"></iframe>
    </div>
    <input type="button" onclick="escondeDetallesMuestraTabla()" value="Volver">
</div> -->
<div id="divAcciones" style="display:none" class="scroll border rounded overflow-auto">
    <div id="injectTarget" style="height:300px"></div>
    <button id="buttonComponentNav" onclick="escondeDetallesMuestraTabla()" class="btn btn-primary btn-sm">Volver a los
        tramos</button>
</div>
{% endblock %}
